name: Build & Release (Windows)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  windows:
    runs-on: windows-latest

    env:
      RELEASE_TAG: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: |
            backend/requirements.txt
            backend/requirements-dev.txt

      - name: Create backend venv
        shell: pwsh
        run: |
          python -m venv backend/.venv

      - name: Install backend dependencies (incl. PyInstaller)
        shell: pwsh
        run: |
          backend\.venv\Scripts\python.exe -m pip install -U pip
          backend\.venv\Scripts\python.exe -m pip install -r backend\requirements.txt -r backend\requirements-dev.txt

      - name: Build backend (PyInstaller)
        shell: pwsh
        run: |
          powershell -NoProfile -ExecutionPolicy Bypass -File scripts\build_backend.ps1 -NoInstallDeps

      - name: Install frontend dependencies
        working-directory: frontend
        shell: pwsh
        run: |
          npm ci

      - name: Build desktop distributables (electron-builder)
        working-directory: frontend
        shell: pwsh
        run: |
          npm run dist

      - name: Prepare artifacts + SHA256
        id: prep
        shell: pwsh
        run: |
          $tag = "${{ env.RELEASE_TAG }}"
          $pkgVer = node -p "require('./frontend/package.json').version"

          $ver = $pkgVer
          if ($tag) {
            $ver = $tag
            if ($ver.StartsWith('v')) { $ver = $ver.Substring(1) }
            if ($pkgVer -ne $ver) {
              throw "Tag version ($ver) does not match frontend/package.json version ($pkgVer). Please bump version then create the tag."
            }
          }

          $channel = $ver.Contains('-') ? 'beta' : 'stable'
          $outDir = "release/$channel/$ver"

          if (-not (Test-Path -LiteralPath $outDir -PathType Container)) {
            throw "Output dir not found: $outDir"
          }

          $setupExe = Join-Path $outDir "Edge Video Agent Setup $ver.exe"
          $blockmap = "$setupExe.blockmap"
          $zip = Join-Path $outDir "Edge Video Agent-$ver-win.zip"
          $shaPath = Join-Path $outDir "SHA256SUMS.txt"

          foreach ($p in @($setupExe, $blockmap, $zip)) {
            if (-not (Test-Path -LiteralPath $p -PathType Leaf)) {
              throw "Missing artifact: $p"
            }
          }

          Get-FileHash -Algorithm SHA256 $setupExe, $blockmap, $zip |
            ForEach-Object { "$($_.Hash)  $($_.Path | Split-Path -Leaf)" } |
            Set-Content -Encoding ASCII $shaPath

          $isPre = $ver.Contains('-')
          $isPreStr = $isPre.ToString().ToLowerInvariant()

          "tag=$tag" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "version=$ver" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "channel=$channel" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "out_dir=$outDir" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "prerelease=$isPreStr" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Upload build artifacts (workflow)
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ steps.prep.outputs.version || 'build' }}
          path: |
            ${{ steps.prep.outputs.out_dir || 'release' }}

      - name: Create/Update GitHub Release (gh)
        if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') && steps.prep.outputs.tag != '' }}
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $tag = "${{ steps.prep.outputs.tag }}"
          $ver = "${{ steps.prep.outputs.version }}"
          $outDir = "${{ steps.prep.outputs.out_dir }}"
          $isPre = "${{ steps.prep.outputs.prerelease }}" -eq "true"

          $setupExe = Join-Path $outDir "Edge Video Agent Setup $ver.exe"
          $blockmap = "$setupExe.blockmap"
          $zip = Join-Path $outDir "Edge Video Agent-$ver-win.zip"
          $sha = Join-Path $outDir "SHA256SUMS.txt"

          $notes = "Automated release for $tag."

          $exists = $false
          gh release view $tag --repo "${{ github.repository }}" 1>$null 2>$null
          if ($LASTEXITCODE -eq 0) {
            $exists = $true
          } else {
            $exists = $false
          }

          if (-not $exists) {
            $args = @("release","create",$tag,$setupExe,$blockmap,$zip,$sha,"--repo","${{ github.repository }}","--title",$tag,"--notes",$notes)
            if ($isPre) { $args += "--prerelease" }
            gh @args
          } else {
            gh release upload $tag $setupExe $blockmap $zip $sha --repo "${{ github.repository }}" --clobber
          }
