name: Build & Release (Windows)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Existing tag to build & upload release assets for (e.g. v0.0.1-beta.5)"
        required: true
        default: ""

permissions:
  contents: write

jobs:
  windows:
    runs-on: windows-latest

    env:
      RELEASE_TAG: ${{ (startsWith(github.ref, 'refs/tags/') && github.ref_name) || github.event.inputs.tag || '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ env.RELEASE_TAG != '' && env.RELEASE_TAG || github.ref }}

      - name: Validate workflow_dispatch tag
        if: ${{ github.event_name == 'workflow_dispatch' }}
        shell: pwsh
        run: |
          if (-not "${{ env.RELEASE_TAG }}") {
            throw "workflow_dispatch requires 'tag' input (e.g. v0.0.1-beta.5)."
          }

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: |
            backend/requirements.txt
            backend/requirements-dev.txt

      - name: Create backend venv
        shell: pwsh
        run: |
          python -m venv backend/.venv

      - name: Install backend dependencies (incl. PyInstaller)
        shell: pwsh
        run: |
          backend\.venv\Scripts\python.exe -m pip install -U pip
          backend\.venv\Scripts\python.exe -m pip install -r backend\requirements.txt -r backend\requirements-dev.txt

      - name: Build backend (PyInstaller)
        shell: pwsh
        run: |
          powershell -NoProfile -ExecutionPolicy Bypass -File scripts\build_backend.ps1 -NoInstallDeps

      - name: Install frontend dependencies
        working-directory: frontend
        shell: pwsh
        run: |
          npm ci

      - name: Build desktop distributables (electron-builder)
        working-directory: frontend
        shell: pwsh
        run: |
          $ver = node -p "require('./package.json').version"
          if ($ver.Contains('-')) {
            npm run dist:beta -- --publish never
          } else {
            npm run dist:stable -- --publish never
          }

      - name: Prepare artifacts + SHA256
        id: prep
        shell: pwsh
        run: |
          $tag = "${{ env.RELEASE_TAG }}".Trim()
          if ($tag -and (-not $tag.StartsWith('v'))) {
            throw "Tag must start with 'v' (got: $tag)"
          }
          $pkgVer = node -p "require('./frontend/package.json').version"

          $ver = $pkgVer
          if ($tag) {
            $ver = $tag
            if ($ver.StartsWith('v')) { $ver = $ver.Substring(1) }
            if ($pkgVer -ne $ver) {
              throw "Tag version ($ver) does not match frontend/package.json version ($pkgVer). Please bump version then create the tag."
            }
          }

          $channel = $ver.Contains('-') ? 'beta' : 'stable'
          $outDir = "release/$channel/$ver"

          Write-Host "RELEASE_TAG=$tag"
          Write-Host "pkgVer=$pkgVer"
          Write-Host "ver=$ver"
          Write-Host "channel=$channel"
          Write-Host "outDir=$outDir"

          if (-not (Test-Path -LiteralPath $outDir -PathType Container)) {
            throw "Output dir not found: $outDir"
          }

          $setupExe = Join-Path $outDir "Edge Video Agent Setup $ver.exe"
          $blockmap = "$setupExe.blockmap"
          $zip = Join-Path $outDir "Edge Video Agent-$ver-win.zip"
          $shaPath = Join-Path $outDir "SHA256SUMS.txt"

          $yml = ""
          if ($ver.Contains('-')) {
            $pre = $ver.Split('-', 2)[1]
            $preTag = $pre.Split('.', 2)[0]
            $cand1 = Join-Path $outDir "$preTag.yml"
            $cand2 = Join-Path $outDir "latest.yml"
            if (Test-Path -LiteralPath $cand1 -PathType Leaf) {
              $yml = $cand1
            } elseif (Test-Path -LiteralPath $cand2 -PathType Leaf) {
              $yml = $cand2
            } else {
              $yml = $cand1
            }
          } else {
            $yml = Join-Path $outDir "latest.yml"
          }

          foreach ($p in @($setupExe, $blockmap, $zip, $yml)) {
            if (-not (Test-Path -LiteralPath $p -PathType Leaf)) {
              throw "Missing artifact: $p"
            }
          }

          Get-ChildItem -LiteralPath $outDir -File |
            Sort-Object -Property Name |
            ForEach-Object { Write-Host ("artifact: {0} ({1} bytes)" -f $_.Name, $_.Length) }

          Get-FileHash -Algorithm SHA256 $setupExe, $blockmap, $zip, $yml |
            ForEach-Object { "$($_.Hash)  $($_.Path | Split-Path -Leaf)" } |
            Set-Content -Encoding ASCII $shaPath

          $isPre = $ver.Contains('-')
          $isPreStr = $isPre.ToString().ToLowerInvariant()

          "tag=$tag" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "version=$ver" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "channel=$channel" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "out_dir=$outDir" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "prerelease=$isPreStr" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Upload build artifacts (workflow)
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ steps.prep.outputs.version || 'build' }}
          path: |
            ${{ steps.prep.outputs.out_dir }}/*.exe
            ${{ steps.prep.outputs.out_dir }}/*.exe.blockmap
            ${{ steps.prep.outputs.out_dir }}/*.zip
            ${{ steps.prep.outputs.out_dir }}/*.zip.blockmap
            ${{ steps.prep.outputs.out_dir }}/*.yml
            ${{ steps.prep.outputs.out_dir }}/SHA256SUMS.txt

      - name: Create/Update GitHub Release (gh)
        if: ${{ steps.prep.outputs.tag != '' && ((github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) || github.event_name == 'workflow_dispatch') }}
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $ErrorActionPreference = 'Stop'

          function Assert-LastExitCode([string]$Message) {
            if ($LASTEXITCODE -ne 0) {
              throw "$Message (exit=$LASTEXITCODE)"
            }
          }

          $tag = "${{ steps.prep.outputs.tag }}".Trim()
          $ver = "${{ steps.prep.outputs.version }}"
          $outDir = "${{ steps.prep.outputs.out_dir }}"
          $isPre = "${{ steps.prep.outputs.prerelease }}" -eq "true"

          Write-Host "Uploading release assets for tag=$tag ver=$ver outDir=$outDir isPre=$isPre"

          $setupExe = Join-Path $outDir "Edge Video Agent Setup $ver.exe"
          $blockmap = "$setupExe.blockmap"
          $zip = Join-Path $outDir "Edge Video Agent-$ver-win.zip"
          $sha = Join-Path $outDir "SHA256SUMS.txt"

          $yml = ""
          if ($ver.Contains('-')) {
            $pre = $ver.Split('-', 2)[1]
            $preTag = $pre.Split('.', 2)[0]
            $cand1 = Join-Path $outDir "$preTag.yml"
            $cand2 = Join-Path $outDir "latest.yml"
            if (Test-Path -LiteralPath $cand1 -PathType Leaf) {
              $yml = $cand1
            } elseif (Test-Path -LiteralPath $cand2 -PathType Leaf) {
              $yml = $cand2
            } else {
              $yml = $cand1
            }
          } else {
            $yml = Join-Path $outDir "latest.yml"
          }

          $notes = "Automated release for $tag."

          $exists = $false
          gh release view $tag --repo "${{ github.repository }}" 1>$null 2>$null
          if ($LASTEXITCODE -eq 0) {
            $exists = $true
          } else {
            $exists = $false
          }

          if (-not $exists) {
            $args = @("release","create",$tag,$setupExe,$blockmap,$zip,$yml,$sha,"--repo","${{ github.repository }}","--title",$tag,"--notes",$notes,"--verify-tag")
            if ($isPre) { $args += "--prerelease" }
            gh @args
            Assert-LastExitCode "gh release create failed"
          } else {
            gh release upload $tag $setupExe $blockmap $zip $yml $sha --repo "${{ github.repository }}" --clobber
            Assert-LastExitCode "gh release upload failed"
          }

          # Ensure release is NOT a draft (draft releases do not show up as normal assets and break auto-update)
          $relJson = gh api "repos/${{ github.repository }}/releases/tags/$tag"
          Assert-LastExitCode "gh api get release failed"
          $rel = $relJson | ConvertFrom-Json
          $relId = $rel.id
          $preVal = $isPre.ToString().ToLowerInvariant()
          gh api --method PATCH "repos/${{ github.repository }}/releases/$relId" -f draft=false -f prerelease=$preVal 1>$null
          Assert-LastExitCode "gh api update release (draft/prerelease) failed"

          $assetNames = gh release view $tag --repo "${{ github.repository }}" --json assets --jq ".assets[].name"
          Assert-LastExitCode "gh release view (post-upload) failed"
          if (-not $assetNames) {
            throw "Release $tag still has no uploaded assets (only source archives)."
          }
          Write-Host "Release assets:" 
          $assetNames
