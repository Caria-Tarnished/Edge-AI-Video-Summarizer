# 需求文档

## 简介

本文档规定了端侧视频智能助手（Edge Video Agent）桌面应用的需求——一个隐私优先、本地运行的智能代理，用于长视频内容的整理、摘要生成和交互式问答。

## 术语表

- **系统（System）**: 端侧视频智能助手桌面应用程序
- **用户（User）**: 使用应用程序处理和交互视频内容的人
- **视频处理器（Video_Processor）**: 负责视频文件处理和预处理的组件
- **语音识别引擎（ASR_Engine）**: 自动语音识别引擎（Faster-Whisper）
- **大语言模型引擎（LLM_Engine）**: 大语言模型推理引擎（Qwen2.5-7B-Instruct）
- **向量数据库（Vector_Database）**: 用于存储和检索文本嵌入的 ChromaDB 实例
- **转写文本（Transcript）**: 语音识别输出的带时间戳的文本
- **文本块（Chunk）**: 带有关联时间戳的转写文本片段
- **嵌入向量（Embedding）**: 用于语义搜索的文本向量表示
- **摘要（Summary）**: 描述视频内容的结构化文本输出
- **检索增强生成系统（RAG_System）**: 用于问答的检索增强生成系统
- **任务（Job）**: 后台任务（转写、嵌入、摘要生成）
- **关键帧（Keyframe）**: 从视频特定时间戳提取的代表性图像
- **性能档位（Performance_Profile）**: 配置预设（CPU 友好型、GPU 推荐型、轻量独显型）

## 需求

### 需求 1：视频导入和管理

**用户故事：** 作为用户，我希望将视频文件导入应用程序，以便在本地处理和整理长视频内容。

#### 验收标准

1. WHEN 用户选择视频文件时，THE 系统 SHALL 验证文件格式和大小
2. WHEN 导入有效视频文件时，THE 系统 SHALL 计算内容哈希并在 SQLite 中存储元数据
3. WHEN 再次导入相同视频文件时，THE 系统 SHALL 检测重复并重用现有处理结果
4. WHEN 用户查看视频库时，THE 系统 SHALL 显示所有已导入视频的缩略图和元数据
5. THE 系统 SHALL 支持常见视频格式，包括 MP4、AVI、MOV、MKV、FLV 和 WMV

### 需求 2：音频提取和预处理

**用户故事：** 作为用户，我希望系统自动从视频中提取音频，以便高效地进行语音识别。

#### 验收标准

1. WHEN 导入视频时，THE 视频处理器 SHALL 使用 FFmpeg 提取音频轨道
2. THE 视频处理器 SHALL 将音频转换为 16kHz 单声道 WAV 格式
3. WHEN 音频提取失败时，THE 系统 SHALL 记录错误并通知用户
4. THE 视频处理器 SHALL 存储提取的音频并关联源视频哈希
5. WHEN 视频哈希对应的音频已存在时，THE 系统 SHALL 跳过重新提取

### 需求 3：语音识别和转写

**用户故事：** 作为用户，我希望视频能够自动转写并带有时间戳，以便搜索和引用内容中的特定时刻。

#### 验收标准

1. WHEN 音频可用时，THE 语音识别引擎 SHALL 使用 Faster-Whisper 进行转写
2. THE 语音识别引擎 SHALL 生成包含开始时间、结束时间和文本内容的片段
3. THE 系统 SHALL 根据性能档位支持多种模型大小（tiny、base、small、medium、large-v3）
4. WHEN 转写完成时，THE 系统 SHALL 以 JSON 格式存储片段并关联视频 ID
5. THE 系统 SHALL 保留所有片段相对于原始视频的绝对时间戳
6. WHEN 转写过程中失败时，THE 系统 SHALL 保存已完成的片段并允许从最后检查点恢复

### 需求 4：长视频分段策略

**用户故事：** 作为用户，我希望长视频（40分钟-2小时）能够分段处理，以便系统保持响应性并能从中断中恢复。

#### 验收标准

1. WHEN 处理超过 5 分钟的视频时，THE 系统 SHALL 将音频分割为 30-90 秒的块，重叠 2-5 秒
2. THE 系统 SHALL 独立处理片段并增量存储结果
3. WHEN 片段处理失败时，THE 系统 SHALL 允许重试该片段而无需重新处理其他片段
4. THE 系统 SHALL 将片段相对时间戳映射到绝对视频时间戳
5. WHEN 应用程序重启时，THE 系统 SHALL 从最后完成的片段恢复处理

### 需求 5：文本分块和嵌入

**用户故事：** 作为用户，我希望转写文本能够进行语义索引，以便对视频内容进行智能搜索和问答。

#### 验收标准

1. WHEN 转写完成时，THE 系统 SHALL 将转写文本分割为语义块
2. THE 系统 SHALL 使用 BGE-M3 或 m3e-base 模型为每个块生成嵌入向量
3. THE 系统 SHALL 在向量数据库中存储嵌入向量，包含视频 ID、开始时间戳和结束时间戳等元数据
4. WHEN 块大小超过模型上下文限制时，THE 系统 SHALL 进一步分割该块
5. THE 系统 SHALL 按内容哈希缓存嵌入向量以避免重复计算

### 需求 6：层级摘要

**用户故事：** 作为用户，我希望自动生成摘要和大纲，以便无需观看整个视频就能快速理解视频内容。

#### 验收标准

1. WHEN 转写块可用时，THE 大语言模型引擎 SHALL 使用 Map 阶段生成片段级摘要
2. THE 大语言模型引擎 SHALL 使用 Reduce 阶段生成章节摘要和总体摘要
3. THE 系统 SHALL 从内容中提取关键实体和主题
4. THE 系统 SHALL 生成具有层级结构的结构化大纲
5. WHEN 摘要生成失败时，THE 系统 SHALL 保留部分结果并允许重试

### 需求 7：关键帧提取

**用户故事：** 作为用户，我希望从视频中提取代表性图像，以便直观地导航内容并快速理解上下文。

#### 验收标准

1. WHEN 导入视频时，THE 视频处理器 SHALL 使用 FFmpeg 提取关键帧
2. THE 系统 SHALL 支持固定间隔提取（每 10-15 秒）和场景变化检测
3. THE 视频处理器 SHALL 将关键帧存储为 JPEG 或 WebP 格式，控制质量和大小
4. THE 系统 SHALL 在 SQLite 中索引关键帧，包含视频 ID、时间戳和文件路径
5. WHEN 显示摘要或大纲时，THE 系统 SHALL 根据时间戳范围将相关关键帧与每个部分关联

### 需求 8：基于 RAG 的问答

**用户故事：** 作为用户，我希望能够对视频内容提出自然语言问题，以便快速找到特定信息而无需手动搜索。

#### 验收标准

1. WHEN 用户提交问题时，THE 检索增强生成系统 SHALL 为问题生成嵌入向量
2. THE 检索增强生成系统 SHALL 从向量数据库中检索最相关的前 k 个块
3. THE 检索增强生成系统 SHALL 构建包含检索上下文和系统指令的提示
4. THE 大语言模型引擎 SHALL 生成带有 [HH:MM:SS.mmm] 格式时间戳引用的答案
5. WHEN 显示答案时，THE 系统 SHALL 使时间戳引用可点击以进行视频导航

### 需求 9：后台任务管理

**用户故事：** 作为用户，我希望长时间运行的任务在后台执行，以便 UI 保持响应性，我可以继续工作。

#### 验收标准

1. WHEN 启动处理任务时，THE 系统 SHALL 在 SQLite 中创建带有状态跟踪的任务条目
2. THE 系统 SHALL 使用本地工作进程（multiprocessing 或 asyncio）执行任务
3. THE 系统 SHALL 根据性能档位限制并发任务（例如轻量档位为 1 个 ASR + 1 个 LLM）
4. THE 系统 SHALL 通过 WebSocket 向 UI 推送进度更新
5. WHEN 用户取消任务时，THE 系统 SHALL 停止处理并清理资源
6. WHEN 应用程序退出时，THE 系统 SHALL 优雅地停止所有运行中的任务

### 需求 10：检查点和恢复

**用户故事：** 作为用户，我希望处理能够在中断后从停止的地方恢复，以便不会丢失长时间运行任务的进度。

#### 验收标准

1. WHEN 处理被中断时，THE 系统 SHALL 将所有中间结果（转写、嵌入、摘要）保存到磁盘
2. THE 系统 SHALL 将所有产物与视频内容哈希关联
3. WHEN 重新处理相同视频时，THE 系统 SHALL 检测现有产物并跳过已完成的阶段
4. THE 系统 SHALL 记录处理元数据，包括模型版本、参数和时间戳
5. WHEN 恢复时，THE 系统 SHALL 在重用前验证产物完整性

### 需求 11：性能档位管理

**用户故事：** 作为用户，我希望选择性能档位，以便应用程序适应我的硬件能力和偏好。

#### 验收标准

1. THE 系统 SHALL 提供三种性能档位：CPU 友好型、GPU 推荐型和轻量独显型
2. WHEN 选择档位时，THE 系统 SHALL 相应配置 ASR 模型大小、LLM 模型大小和并发限制
3. THE 系统 SHALL 检测可用硬件（CPU 核心、RAM、GPU 显存）并推荐适当的档位
4. WHEN 切换档位时，THE 系统 SHALL 将更改应用于新任务而不影响运行中的任务
5. THE 系统 SHALL 在高性能模式下运行时显示资源使用警告

### 需求 12：桌面 UI - 视频播放器

**用户故事：** 作为用户，我希望有一个集成的智能视频播放器，以便在观看视频时访问 AI 生成的见解。

#### 验收标准

1. THE 系统 SHALL 提供带有播放控制的视频播放器（播放、暂停、跳转、速度调整）
2. THE 系统 SHALL 在视频上叠加显示来自转写的同步字幕
3. WHEN 用户点击时间戳引用时，THE 系统 SHALL 将视频跳转到该位置
4. THE 系统 SHALL 显示智能时间轴，用不同颜色标记章节和关键时刻
5. THE 系统 SHALL 支持常见播放操作的键盘快捷键

### 需求 13：桌面 UI - 摘要和大纲视图

**用户故事：** 作为用户，我希望查看结构化摘要和大纲，以便高效地导航视频内容。

#### 验收标准

1. THE 系统 SHALL 显示具有可展开/折叠部分的层级大纲
2. WHEN 用户点击大纲项目时，THE 系统 SHALL 跳转到相应的视频时间戳
3. THE 系统 SHALL 在大纲部分旁边显示关键帧缩略图
4. THE 系统 SHALL 支持将摘要导出为 Markdown 或 HTML 格式，并嵌入图像
5. WHEN 导出时，THE 系统 SHALL 将图像资源与相对路径引用一起打包

### 需求 14：桌面 UI - AI 聊天助手

**用户故事：** 作为用户，我希望与关于视频内容的 AI 助手交互，以便提问并获得上下文相关的答案。

#### 验收标准

1. THE 系统 SHALL 提供类似 ChatGPT 的聊天界面供用户提问
2. WHEN 用户发送消息时，THE 系统 SHALL 立即显示消息并显示加载指示器
3. THE 系统 SHALL 逐令牌流式传输 LLM 响应以提供实时反馈
4. THE 系统 SHALL 在聊天消息中将时间戳引用显示为可点击链接
5. THE 系统 SHALL 维护对话历史以进行上下文感知的后续问题

### 需求 15：桌面 UI - 导航和库

**用户故事：** 作为用户，我希望组织和访问我的视频库，以便高效地管理多个已处理的视频。

#### 验收标准

1. THE 系统 SHALL 显示包含最近文件、收藏夹和设置的导航侧边栏
2. THE 系统 SHALL 提供显示所有已导入视频及其缩略图和元数据的库视图
3. THE 系统 SHALL 支持按标题、日期或标签搜索和过滤视频
4. THE 系统 SHALL 允许用户将视频标记为收藏
5. THE 系统 SHALL 显示每个视频的处理状态（待处理、处理中、完成、错误）

### 需求 16：模型管理和热替换

**用户故事：** 作为开发者或高级用户，我希望灵活地管理 AI 模型，以便为我的硬件优化或尝试不同的模型。

#### 验收标准

1. THE 系统 SHALL 从配置文件（config.yaml）加载模型路径
2. THE 系统 SHALL 支持大语言模型引擎的 GGUF 格式模型
3. WHEN 用户在模型目录中放置新模型时，THE 系统 SHALL 在重启后检测到它
4. THE 系统 SHALL 验证模型兼容性并对不支持的格式显示警告
5. THE 系统 SHALL 提供从可用选项中选择活动模型的 UI

### 需求 17：数据隐私和本地处理

**用户故事：** 作为用户，我希望所有处理都在本地进行，以便我的视频内容和数据保持私密和安全。

#### 验收标准

1. THE 系统 SHALL 在本地执行所有 ASR、嵌入和 LLM 推理，无需云 API 调用
2. THE 系统 SHALL 将所有数据（视频、转写、嵌入、摘要）存储在本地目录中
3. THE 系统 SHALL 不向外部服务器传输任何用户数据
4. THE 系统 SHALL 提供关于数据存储位置的清晰文档
5. THE 系统 SHALL 支持数据导出和备份以供用户控制的迁移

### 需求 18：跨平台桌面支持

**用户故事：** 作为用户，我希望应用程序能在我的操作系统上运行，以便无论我选择什么平台都能使用它。

#### 验收标准

1. THE 系统 SHALL 在 Windows、macOS 和 Linux 操作系统上运行
2. THE 系统 SHALL 打包为独立安装程序（Windows 的 .exe、macOS 的 .dmg、Linux 的 .AppImage）
3. THE 系统 SHALL 捆绑所有 Python 依赖项以避免需要用户环境设置
4. THE 系统 SHALL 提供平台特定的优化（例如 macOS 的 Metal、Windows/Linux 的 CUDA）
5. THE 系统 SHALL 正确处理平台特定的文件路径和权限

### 需求 19：错误处理和用户反馈

**用户故事：** 作为用户，我希望有清晰的错误消息和恢复选项，以便在出现问题时能够理解和解决。

#### 验收标准

1. WHEN 发生错误时，THE 系统 SHALL 显示用户友好的错误消息和可操作的指导
2. THE 系统 SHALL 记录详细的错误信息，包括用于调试的堆栈跟踪
3. WHEN 任务失败时，THE 系统 SHALL 保留部分结果并提供重试选项
4. THE 系统 SHALL 验证用户输入并为无效条目提供即时反馈
5. THE 系统 SHALL 优雅地处理资源耗尽（内存不足、磁盘已满）并提供清晰警告

### 需求 20：应用程序生命周期和更新

**用户故事：** 作为用户，我希望应用程序启动和关闭顺畅，以便我的工作得到保留，系统保持稳定。

#### 验收标准

1. WHEN 应用程序启动时，THE 系统 SHALL 按正确顺序初始化所有服务（数据库、模型、工作进程）
2. WHEN 应用程序退出时，THE 系统 SHALL 优雅地停止所有后台任务并保存状态
3. THE 系统 SHALL 提供首次运行向导用于模型下载和配置
4. THE 系统 SHALL 检查应用程序更新并通知用户新版本
5. THE 系统 SHALL 在初始设置完成后支持离线操作

## MVP 切片与优先级（建议）

为保证可持续交付，建议将上面的需求按里程碑切片（与 `Architecture_Design.md` 对齐）：

### MVP-1：导入 -> 转写 -> 字幕对齐播放

- 覆盖需求：1、2、3、4、9、10、12、19、20
- 交付物：
  - 视频导入与去重（hash）
  - 抽音频（16k mono wav）
  - 分段转写（30-90s + overlap）与断点续跑
  - 转写产物落盘（segments JSON/JSONL）
  - 基础任务队列与进度

### MVP-2：Chunk + Embedding -> 基础检索/问答（RAG）

- 覆盖需求：5、8（基础版）、9、10、11、19

### MVP-3：Map-Reduce 层级摘要与大纲

- 覆盖需求：6、13、9、10、11、19
- 备注：桌面端默认应优先支持本地 LLM；在线 Demo 可使用云模型（但需明确“隐私/联网”差异）。

### MVP-4：关键帧提取与带图大纲/摘要

- 覆盖需求：7、13

### MVP-5：稳定性与体验（队列、性能档位、恢复）

- 覆盖需求：9、10、11、15、16、18、19、20（增强）

## 统一任务状态与进度约定

### Job 状态机

- `pending`：已入队，等待执行
- `running`：执行中
- `completed`：成功完成
- `failed`：失败（保留部分产物，支持重试）
- `cancelled`：用户取消

### 进度字段

- `progress` 范围为 `[0.0, 1.0]`
- `message` 用于 UI 展示阶段提示（如“抽取音频/转写第 N 段/保存结果”）

## 错误码与可观测性（建议）

为便于 UI 侧做可恢复提示，建议将可预期错误归类为枚举错误码：

- `E_INPUT_INVALID`：用户输入不合法/文件格式不支持
- `E_FFMPEG_MISSING`：未检测到 ffmpeg/ffprobe
- `E_FFMPEG_FAILED`：ffmpeg 执行失败（含 stderr 摘要）
- `E_MODEL_LOAD_FAILED`：模型加载失败（路径/权限/依赖/显存）
- `E_ASR_FAILED`：转写失败
- `E_DB_FAILED`：数据库读写失败
- `E_DISK_FULL`：磁盘空间不足
- `E_OOM`：内存/显存不足

同时建议在日志中统一包含：`video_id`、`job_id`、`stage`、`elapsed_ms`、`model_version`、`params`。

## 非目标（当前阶段不做）

- 用户账号体系/云端同步/多人协作
- 云端上传视频进行计算（默认隐私优先，端侧处理）
- 手机端“全流程离线处理”（属于长期路线，优先做轻客户端模式）
